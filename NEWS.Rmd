---
title: "R Luminescence version 0.7.0 </br> - Advanced	Fish -"
author: "R Luminescence Team"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

Dear **R** Luminescence users,

we are happy to announce that another new version of our **R** package (0.7.0) just made it to [CRAN](https://CRAN.R-project.org/package=Luminescence).  
As usual: many thanks for your helpful suggestions and comments!
This is a major update and comes with a lot of bugfixes and several new functions serving  
various requests out of the community. We are excited to present some the new possibilties below. For a full list of all changes please check the CRAN webpage [here](https://cran.r-project.org/web/packages/Luminescence/news.html). 

## What's new?

### New analysis functions

This release comes with two (one of them long requested) new analysis functions:

#### Analyse fading measurements 

Calculating fading corrected ages (`calc_FadingCorr()`) following the approach by Huntley and Lamothe (2001)
was already possible in the package `'Luminescence'` since 2012. Until today, however, a function to analyse the
fading measurements was still missing. The new function `analyse_FadingMeasurement()`
closes this gap by enabling the analysis of typical 'SAR fading' measurement data. 
The function can be directly fed with an `RLum.Analysis` object (raw measurement data) or with an $L_x/T_x$ table 
and returns various numerical and graphical output. On top of that: the output can be directly forwarded 
to other functions, e.g., `calc_FadingCorr()` or `calc_Kars2008()` for further calculations. 

```{r, echo = FALSE, warning = FALSE, message=FALSE}
library("Luminescence")
data("ExampleData.Fading", envir = environment())
fading_data <- ExampleData.Fading$fading.data$IR50
```

```{r, eval=FALSE}
g_value <- analyse_FadingMeasurement(
 object = fading_data,
 structure = c("Lx", "Tx"),
 plot = TRUE,
 verbose = TRUE,
 n.MC = 100)
```

```{r, echo=FALSE, cache = FALSE, fig.width=6, fig.height=4}
par(mfrow = c(1,2))
g_value <- analyse_FadingMeasurement(
 object = fading_data,
 structure = c("Lx", "Tx"),
 plot = TRUE,
 plot.single = c(3,4),
 verbose = TRUE,
 n.MC = 100)
```

#### Analyse data determined by the portable OSL reader

With this version we now also support files produced by a SUERC portable OSL reader.
Importing a PSL file is as easy as running

```{r, cache=FALSE, eval = FALSE}
psl_file <- read_PSL2R(file = "myPSLfile.psl", 
                       drop_bg = TRUE, 
                       as_decay_curve = TRUE, 
                       smooth = TRUE, 
                       merge = TRUE)
```

Note that there are several additional arguments available to modify the data when importing
the raw data to R (see `?read_PSL2R`). Once the data are available in R the next logical step 
would be to analyse them, which can be done via `analyse_portableOSL()`.

```{r, echo = FALSE}
data("ExampleData.portableOSL")
psl_file <- merge_RLum(ExampleData.portableOSL)
```

```{r, cache = FALSE, fig.width=6, fig.height=4}
plot_RLum(object = psl_file, 
          combine = TRUE, 
          subset = list(recordType = c("IRSL", "OSL")))
```


```{r, cache = FALSE, fig.width=6, fig.height=4}
psl_results <- analyse_portableOSL(object = psl_file, 
                                   signal.integral = 1:3, 
                                   invert = FALSE, 
                                   normalise = TRUE, 
                                   plot = TRUE)

round(get_RLum(psl_results), 2)
```

As can be seen `analyse_portableOSL()` produces a recognizable plot of commonly
reported parameters, i.e. the signal intensities, depletion ratios and signal ratios.
The functions returns the numeric values, which can be used for further processing
if desired.


### New models

#### Anomalous fading correction for feldspar IRSL (Kars et al., 2008)

The newly introduced function `calc_Kars2008()` applies the approach described in Kars et al. (2008), 
developed from the model of Huntley (2006)
to calculate the expected sample specific fraction of saturation of a feldspar and also to 
calculate fading corrected age using this model. The density of recombination centres ρ'
is a crucial parameter of this model and must be determined separately from a fading measurement. 
The function `analyse_FadingMeasurement()` can be used to calculate the sample specific ρ' value.

Below an example with the example data provided by the package:

```{r}
data("ExampleData.Fading", envir = environment())
fading_data <- ExampleData.Fading$fading.data$IR50

rhop <- analyse_FadingMeasurement(fading_data, 
                                  plot = FALSE, 
                                  verbose = FALSE, 
                                  n.MC = 999)
```



```{r, fig.width=6, fig.height=6, fig.keep='last'}
lxtx_data <- ExampleData.Fading$equivalentDose.data$IR50

kars_res <- calc_Kars2008(data = lxtx_data,
                          rhop = rhop,
                          ddot = c(7.00, 0.004),
                          readerDdot = c(0.134, 0.0067),
                          n.MC = 999)
```

The `calc_Kars2008()` function also calculates the level of saturation $\left(\frac{n}{N}\right)$
and the field saturation (i.e. athermal steady state, $\left(\frac{n}{N}\right)_{SS}$)
value for the sample under investigation using the sample specific ρ', 
unfaded D0 and environmental dose rate $\dot{D}$ values, following the approach of Kars et al. (2008). 

#### Average Dose Model (Guérin et al., 2017)

To overcome the drawbacks of commonly used age (dose) models, Guérin et al., 2017 introduced
a new dose model that calculates the average dose and their extrinsic dispersion and standard error
by bootstrapping. The function fits neatly into the collection of functions dealing with 
age (dose) models. Example for the package example data set:

```{r, fig.width=7, fig.height=3}
data(ExampleData.DeValues, envir = environment())
AD <- calc_AverageDose(ExampleData.DeValues$CA1[1:56,],
sigma_m = 0.1)
```

### Conversions

Even data export to CSV-files is already part of **R**'s base functionality, we decided to make
it even easier and more straight forward. Four new functions allow a direct and straight forward
conversion from proprietary input formats to CSV-files

* `convert_BIN2CSV()`
* `convert_Daybreak2CSV()`
* `convert_PSL2CSV()`
* `convert_XSYG2CSV()`
* `write_RLum2CSV()`


### Miscellaneous

#### Getting closer with GitHub
As some of you may already know the R package `'Luminescence'` is actively developed and
maintained on the web-based Git repository hosting service GitHub. In this package
version we introduce a couple of new functions that make use of the public GitHub API v3.

With `github_issues()` you can query known issues (output shortened):
```{r, eval = FALSE}
github_issues()
```

```{r, echo = FALSE}
issues <- capture.output(github_issues())
cat(paste(issues[189:202], collapse = "\n"))
```

`github_branches()` can be used to check all currently available development branches. The
output further provides an install command that can be used to manually install a
specific development branch.

```{r}
github_branches()
```

Finally, `github_commits()` returns the latest *n* code commits to the package:

```{r}
github_commits(n = 1)
```


Ultimately, all these functions are the foundation for the also newly introduced function
`install_DevelopmentVersion()`. This function is a convenient method for installing the development 
version of the R package `'Luminescence'` directly from GitHub. This function uses `github_branches()` to 
check which development branches of the R package `'Luminescence'` are currently available on GitHub. 
The user is then prompted to choose one of the branches to be installed. It further checks whether 
the R package `'devtools'` is currently installed and available on the system. Finally, it prints 
R code to the console that the user can copy and paste to the R console in order to install the 
desired development version of the package. 

Alternatively, with `force_install = TRUE` the functions checks if `'devtools'` is available and then attempts to 
install the chosen development branch via `install_github()`.

```{r, eval = FALSE}
install_DevelopmentVersion()
install_DevelopmentVersion(force_install = TRUE)
```


#### Pipe your data
In the R-community a new operator, called 'magrittr forward-pipe operator' or short `%>%` from 
the package `magrittr` turned out as being very efficient for scripting **R** code. With this
operator values can be direclty piped from one function to another. Example:

```{r}
rnorm(1000) %T>% hist(freq = FALSE, breaks = "FD") %>% density %>% lines
```

In order to further support this opperator, the package `magrittr` is now loaded by default when 
attaching the package `'Luminescence'`

#### Other enhancements 

* Thanks to Antoine Zink the function `read_Daybreak2R()` now also handles binary files produced
by the software TLAPLLIC v.3.2, which is used for a Daybreak, model 1100.


## References

Huntley, D.J., Lamothe, M., 2001. Ubiquity of anomalous fading in K-feldspars and the measurement and correction for it in optical dating. Canadian Journal of Earth Sciences 38, 1093–1106. doi:10.1139/cjes-38-7-1093

Huntley, D.J., 2006. An explanation of the power-law decay of luminescence. Journal of Physics: Condensed Matter 18, 1359-1365. doi:10.1088/0953-8984/18/4/020

Kars, R.H., Wallinga, J., Cohen, K.M., 2008. A new approach towards anomalous fading correction for feldspar IRSL dating-tests on samples in field saturation. Radiation Measurements 43, 786-790. doi:10.1016/j.radmeas.2008.01.021