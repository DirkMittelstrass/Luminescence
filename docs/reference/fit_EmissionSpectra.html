<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Luminescence Emission Spectra Deconvolution — fit_EmissionSpectra • Luminescence</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />


<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Luminescence Emission Spectra Deconvolution — fit_EmissionSpectra" />
<meta property="og:description" content="Luminescence spectra deconvolution on RLum.Data.Spectrum and matrix objects
on an energy scale. The function is optimised for emission spectra typically
obtained in the context of TL, OSL and RF measurements detected between 200 and 1000 nm." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Luminescence</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.9.15</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/R-Lum/Luminescence/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Luminescence Emission Spectra Deconvolution</h1>
    <small class="dont-index">Source: <a href='https://github.com/R-Lum/Luminescence/blob/master/R/fit_EmissionSpectra.R'><code>R/fit_EmissionSpectra.R</code></a></small>
    <div class="hidden name"><code>fit_EmissionSpectra.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Luminescence spectra deconvolution on <a href='RLum.Data.Spectrum-class.html'>RLum.Data.Spectrum</a> and <a href='https://rdrr.io/r/base/matrix.html'>matrix</a> objects
on an <strong>energy scale</strong>. The function is optimised for emission spectra typically
obtained in the context of TL, OSL and RF measurements detected between 200 and 1000 nm.</p>
    </div>

    <pre class="usage"><span class='fu'>fit_EmissionSpectra</span><span class='op'>(</span>
  <span class='va'>object</span>,
  frame <span class='op'>=</span> <span class='cn'>NULL</span>,
  n_components <span class='op'>=</span> <span class='cn'>NULL</span>,
  start_parameters <span class='op'>=</span> <span class='cn'>NULL</span>,
  sub_negative <span class='op'>=</span> <span class='fl'>0</span>,
  input_scale <span class='op'>=</span> <span class='cn'>NULL</span>,
  method_control <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='op'>)</span>,
  verbose <span class='op'>=</span> <span class='cn'>TRUE</span>,
  plot <span class='op'>=</span> <span class='cn'>TRUE</span>,
  <span class='va'>...</span>
<span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>object</th>
      <td><p><a href='RLum.Data.Spectrum-class.html'>RLum.Data.Spectrum</a>, <a href='https://rdrr.io/r/base/matrix.html'>matrix</a> (<strong>required</strong>): input
object. Please note that an energy spectrum is expected</p></td>
    </tr>
    <tr>
      <th>frame</th>
      <td><p><a href='https://rdrr.io/r/base/numeric.html'>numeric</a> (<em>optional</em>): defines the frame to be analysed</p></td>
    </tr>
    <tr>
      <th>n_components</th>
      <td><p><a href='https://rdrr.io/r/base/numeric.html'>numeric</a> (<em>optional</em>): allows a number of the aimed number of
components. However, it defines rather a maximum than than a minimum. Can be combined with
other parameters.</p></td>
    </tr>
    <tr>
      <th>start_parameters</th>
      <td><p><a href='https://rdrr.io/r/base/numeric.html'>numeric</a> (<em>optional</em>): allows to provide own start parameters for a
semi-automated procedure. Parameters need to be provided in eV. Every value provided replaces a
value from the automated peak finding algorithm (in ascending order).</p></td>
    </tr>
    <tr>
      <th>sub_negative</th>
      <td><p><a href='https://rdrr.io/r/base/numeric.html'>numeric</a> (<em>with default</em>): substitute negative values in the input object
by the number provided here (default: <code>0</code>). Can be set to <code>NULL</code>, i.e. negative values are kept.</p></td>
    </tr>
    <tr>
      <th>input_scale</th>
      <td><p><a href='https://rdrr.io/r/base/character.html'>character</a> (<em>optional</em>): defines whether your x-values define wavelength or
energy values. For the analysis an energy scale is expected, allowed values are <code>'wavelength'</code> and
<code>'energy'</code>. If nothing (<code>NULL</code>) is defined, the function tries to understand the input
automatically.</p></td>
    </tr>
    <tr>
      <th>method_control</th>
      <td><p><a href='https://rdrr.io/r/base/list.html'>list</a> (<em>optional</em>): options to control the fit method, see details</p></td>
    </tr>
    <tr>
      <th>verbose</th>
      <td><p><a href='https://rdrr.io/r/base/logical.html'>logical</a> (<em>with default</em>): enable/disable verbose mode</p></td>
    </tr>
    <tr>
      <th>plot</th>
      <td><p><a href='https://rdrr.io/r/base/logical.html'>logical</a> (<em>with default</em>): enable/disable plot output</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>further arguments to be passed to control the plot output
(supported: <code>main</code>, <code>xlab</code>, <code>ylab</code>, <code>xlim</code>, <code>ylim</code>, <code>log</code>, <code>mtext</code>, <code>legend</code> (<code>TRUE</code> or <code>FALSE</code>),
<code>legend.text</code>, <code>legend.pos</code>)</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>-----------------------------------<br />
<code>[ NUMERICAL OUTPUT ]</code><br />
-----------------------------------<br /></p>
<p><strong><code>RLum.Results</code></strong>-object</p>
<p><strong>slot:</strong> <strong><code>@data</code></strong></p>
<table class='table'>
<tr><td><strong>Element</strong></td><td><strong>Type</strong></td><td><strong>Description</strong></td></tr>
<tr><td><code>$data</code></td><td><code>matrix</code></td><td>the final fit matrix</td></tr>
<tr><td><code>$fit</code></td><td><code>nls</code></td><td>the fit object returned by <a href='https://rdrr.io/pkg/minpack.lm/man/nls.lm.html'>minpack.lm::nls.lm</a></td></tr>
<tr><td><code>$fit_info</code></td><td><code>list</code></td><td>a few additional parameters that can be used to asses the quality
of the fit</td></tr>
</table>


<p><strong>slot:</strong> <strong><code>@info</code></strong></p>
<p>The original function call</p>
<p>---------------------------------<br />
<code>[ TERMINAL OUTPUT ]</code>   <br />
---------------------------------<br /></p>
<p>The terminal output provides brief information on the
deconvolution process and the obtained results.
Terminal output is only shown of the argument <code>verbose = TRUE</code>.</p>
<p>---------------------------<br />
<code>[ PLOT OUTPUT ]</code>      <br />
---------------------------<br /></p>
<p>The function returns a plot showing the raw signal with the
detected components. If the fitting failed, a basic plot is returned
showing the raw data and indicating the peaks detected for the start
parameter estimation. The grey band in the residual plot indicates the
10% deviation from 0 (means no residual).</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p><strong>Used equation</strong></p>
<p>The emission spectra (on an energy scale) can be best described as the sum of multiple
Gaussian components:</p>
<p>'$$
y = \Sigma  Ci * 1/(\sigma_{i} * \sqrt(2 * \pi)) * exp(-1/2 * ((x - \mu_{i})/\sigma_{i}))^2)
$$</p>
<p>with the parameters \(\sigma\) (peak width) and \(\mu\) (peak centre) and \(C\)
(scaling factor).</p>
<p><strong>Start parameter estimation and fitting algorithm</strong></p>
<p>The spectrum deconvolution consists of the following steps:</p><ol>
<li><p>Peak finding <br /></p></li>
<li><p>Start parameter estimation <br /></p></li>
<li><p>Fitting via <a href='https://rdrr.io/pkg/minpack.lm/man/nls.lm.html'>minpack.lm::nls.lm</a><br /></p></li>
</ol>

<p>The peak finding is realised by an approach (re-)suggested by Petr Pikal via the R-help
mailing list (<code>https://stat.ethz.ch/pipermail/r-help/2005-November/thread.html</code>) in November 2005.
This goes back to even earlier discussion in 2001 based on Prof Brian Ripley's idea.
It smartly uses the functions <a href='https://rdrr.io/r/stats/embed.html'>stats::embed</a> and <a href='https://rdrr.io/r/base/maxCol.html'>max.col</a> to identify peaks positions.
For the use in this context, the algorithm has been further modified to scale on the
input data resolution (cf. source code).<br /></p>
<p>The start parameter estimation uses random sampling from a range of meaningful parameters
and repeats the fitting until 1000 successful fits have been produced or the set <code>max.runs</code> value
is exceeded.</p>
<p>Currently the best fit is the one with the lowest number for squared residuals, but
other parameters are returned as well. If a series of curves needs to be analysed,
it is recommended to make few trial runs, then fix the number of components and
run  at least 10,000 iterations (parameter <code>method_control = list(max.runs = 10000)</code>).</p>
<p><strong>Supported <code>method_control</code> settings</strong></p>
<table class='table'>
<tr><td><strong>Parameter</strong></td><td><strong>Type</strong></td><td><strong>Default</strong></td><td><strong>Description</strong></td></tr>
<tr><td><code>max.runs</code></td><td><a href='https://rdrr.io/r/base/integer.html'>integer</a></td><td><code>10000</code></td><td>maximum allowed search iterations, if exceed
the searching stops</td></tr>
<tr><td><code>graining</code></td><td><a href='https://rdrr.io/r/base/numeric.html'>numeric</a></td><td><code>15</code></td><td>gives control over how coarse or fine the spectrum is split into search intervals for the peak finding algorithm</td></tr>
<tr><td><code>trace</code></td><td><a href='https://rdrr.io/r/base/logical.html'>logical</a></td><td><code>FALSE</code></td><td>enables/disables the tracing of the minimisation routine</td></tr>
</table>


    <h2 class="hasAnchor" id="function-version"><a class="anchor" href="#function-version"></a>Function version</h2>

    <p>0.1.0</p>
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p><a href='RLum.Data.Spectrum-class.html'>RLum.Data.Spectrum</a>, <a href='RLum.Results-class.html'>RLum.Results</a>, <a href='plot_RLum.html'>plot_RLum</a>,
<a href='convert_Wavelength2Energy.html'>convert_Wavelength2Energy</a>, <a href='https://rdrr.io/pkg/minpack.lm/man/nls.lm.html'>minpack.lm::nls.lm</a></p></div>
    <h2 class="hasAnchor" id="author"><a class="anchor" href="#author"></a>Author</h2>

    <p>Sebastian Kreutzer, Geography &amp; Earth Sciences, Aberystwyth University (United Kingdom)
, RLum Developer Team</p>
    <h2 class="hasAnchor" id="how-to-cite"><a class="anchor" href="#how-to-cite"></a>How to cite</h2>

    <p>Kreutzer, S., 2021. fit_EmissionSpectra(): Luminescence Emission Spectra Deconvolution. Function version 0.1.0. In: Kreutzer, S., Burow, C., Dietze, M., Fuchs, M.C., Schmidt, C., Fischer, M., Friedrich, J., Mercier, N., Philippe, A., Riedesel, S., Autzen, M., Mittelstrass, D., Gray, H.J., 2021. Luminescence: Comprehensive Luminescence Dating Data Analysis. R package version 0.9.15. https://CRAN.R-project.org/package=Luminescence</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'>
<span class='co'>##load example data</span>
<span class='fu'><a href='https://rdrr.io/r/utils/data.html'>data</a></span><span class='op'>(</span><span class='va'>ExampleData.XSYG</span>, envir <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/environment.html'>environment</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'>##subtract background</span>
<span class='va'>TL.Spectrum</span><span class='op'>@</span><span class='va'>data</span> <span class='op'>&lt;-</span> <span class='va'>TL.Spectrum</span><span class='op'>@</span><span class='va'>data</span><span class='op'>[</span><span class='op'>]</span> <span class='op'>-</span> <span class='va'>TL.Spectrum</span><span class='op'>@</span><span class='va'>data</span><span class='op'>[</span>,<span class='fl'>15</span><span class='op'>]</span>

<span class='va'>results</span> <span class='op'>&lt;-</span> <span class='fu'>fit_EmissionSpectra</span><span class='op'>(</span>
 object <span class='op'>=</span> <span class='va'>TL.Spectrum</span>,
 frame <span class='op'>=</span> <span class='fl'>5</span>,
 method_control <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>max.runs <span class='op'>=</span> <span class='fl'>10</span><span class='op'>)</span>
<span class='op'>)</span>
</div><div class='output co'>#&gt; 
#&gt; [fit_EmissionSpectra()]
#&gt; 
#&gt; &gt;&gt; Treating dataset &gt;&gt; 5 &lt;&lt;
#&gt; &gt;&gt; Wavelength scale detected ...
#&gt; &gt;&gt; Wavelength to energy scale conversion ... 	[OK]
#&gt; &gt;&gt; Searching components ... 			[/]&gt;&gt; Searching components ... 			[-]&gt;&gt; Searching components ... 			[/]&gt;&gt; Searching components ... 			[/]&gt;&gt; Searching components ... 			[-]&gt;&gt; Searching components ... 			[-]&gt;&gt; Searching components ... 			[-]&gt;&gt; Searching components ... 			[-]&gt;&gt; Searching components ... 			[/]&gt;&gt; Searching components ... 			[/]&gt;&gt; Searching components ... 			[OK]
#&gt; 
#&gt; &gt;&gt; Fitting results (2 component model):
#&gt; -------------------------------------------------------------------------
#&gt;            mu       SE(mu)     sigma   SE(sigma)         C       SE(C)
#&gt; [1,] 2.254804 0.0009376487 0.1108407 0.001281582 0.2123040 0.003973387
#&gt; [2,] 2.762989 0.0033730176 0.3217260 0.003498874 0.5712502 0.005464677
#&gt; -------------------------------------------------------------------------
#&gt; SE: standard error | SSR: 1.517e+00| R^2: 0.986 | R^2_adj: 0.0136
#&gt; (use the output in $fit for a more detailed analysis)
#&gt; </div><div class='img'><img src='fit_EmissionSpectra-1.png' alt='' width='700' height='433' /></div><div class='input'>
<span class='co'>##deconvolution of a TL spectrum</span>
<span class='kw'>if</span> <span class='op'>(</span><span class='cn'>FALSE</span><span class='op'>)</span> <span class='op'>{</span>

<span class='co'>##load example data</span>

<span class='co'>##replace 0 values</span>
<span class='va'>results</span> <span class='op'>&lt;-</span> <span class='fu'>fit_EmissionSpectra</span><span class='op'>(</span>
 object <span class='op'>=</span> <span class='va'>TL.Spectrum</span>,
 frame <span class='op'>=</span> <span class='fl'>5</span>, main <span class='op'>=</span> <span class='st'>"TL spectrum"</span>
<span class='op'>)</span>

<span class='op'>}</span>

</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Sebastian Kreutzer, Christoph Burow, Michael Dietze, Margret C. Fuchs, Christoph Schmidt, Manfred Fischer, Johannes Friedrich, Norbert Mercier, Anne Philippe, Svenja Riedesel, Martin Autzen, Dirk Mittelstrass, Harrison J. Gray.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


